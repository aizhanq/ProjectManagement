<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        h1, h2 {
            color: #007bff;
        }

        button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Детали проекта</h1>

    <div id="projectDetails"></div>
    <h2>Сотрудники проекта</h2>
    <ul id="projectEmployees"></ul>

    <h2>Добавить сотрудника в проект</h2>
    <select id="employeeDropdown"></select>
    <button onclick="handleAddEmployee()">Добавить в проект</button>

    <!-- Добавить после сотрудников -->
    <p><strong>Менеджер:</strong> <span id="managerName"></span></p>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        const formatDateTime = (dateTimeString) => new Date(dateTimeString).toLocaleString();

        const handleDeleteEmployee = (employeeId) => {
            fetch(`/api/Project/${projectId}/employees/${employeeId}`, { method: 'DELETE' })
                .then(response => response.ok && updateEmployeesList())
                .catch(error => console.error('Error:', error));
        };

        const handleAddEmployee = () => {
            const employeeDropdown = document.getElementById("employeeDropdown");
            const selectedEmployeeId = employeeDropdown.value;

            if (selectedEmployeeId) {
                fetch(`/api/Project/${projectId}/employees/${selectedEmployeeId}`, { method: 'POST' })
                    .then(response => response.ok && updateEmployeesList())
                    .catch(error => console.error('Error:', error));
            }
        };

        const updateDetails = () => {
            fetch(`/api/Project/${projectId}`)
                .then(response => response.json())
                .then(project => {
                    const projectDetails = document.getElementById("projectDetails");
                    projectDetails.innerHTML = `
                                    <p><strong>Название проекта:</strong> ${project.projectName}</p>
                                    <p><strong>Заказчик:</strong> ${project.customerCompany}</p>
                                    <p><strong>Исполнитель:</strong> ${project.executorCompany}</p>
                                    <p><strong>Менеджер:</strong> <span id="managerName"></span></p>
                                    <p><strong>Дата начала:</strong> ${formatDateTime(project.startDate)}</p>
                                    <p><strong>Дата окончания:</strong> ${formatDateTime(project.endDate)}</p>
                                    <p><strong>Приоритет:</strong> ${project.priority}</p>
                                `;

                    // Добавлено обновление имени менеджера
                    const managerNameElement = document.getElementById("managerName");
                    fetch(`/api/Employee/${project.managerId}`)
                        .then(response => response.json())
                        .then(manager => {
                            managerNameElement.textContent = `${manager.firstName} ${manager.lastName}`;
                        });
                });

            updateEmployeesList();
            updateEmployeeDropdown();
        };

        const updateEmployeesList = () => {
            fetch(`/api/Project/${projectId}/employees`)
                .then(response => response.json())
                .then(employees => {
                    const projectEmployees = document.getElementById("projectEmployees");
                    projectEmployees.innerHTML = employees.map(employee => `
                                    <li>${employee.firstName} ${employee.lastName}
                                        <button onclick="handleDeleteEmployee(${employee.employeeId})">Удалить</button>
                                    </li>`).join('');
                });
        };

        const updateEmployeeDropdown = () => {
            fetch(`/api/Employee`)
                .then(response => response.json())
                .then(employees => {
                    const employeeDropdown = document.getElementById("employeeDropdown");
                    employeeDropdown.innerHTML = employees.map(employee => `
                                    <option value="${employee.employeeId}">${employee.firstName} ${employee.lastName}</option>`).join('');
                });
        };

        window.onload = updateDetails;
    </script>
</body>
</html>
